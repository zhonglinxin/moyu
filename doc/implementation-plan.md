# 摸鱼特工 - 实现计划

## 模块依赖关系图

```
基础设施层
    ↓
核心系统层
    ↓  
游戏实体层
    ↓
游戏逻辑层
    ↓
表现层(UI/音效)
```

## 实现顺序（按优先级）

### 第一阶段：基础架构搭建
**目标**：建立游戏基础框架，确保Phaser与Next.js正确集成

1. **Phaser集成方案**
   - 创建Phaser包装组件（处理SSR问题）
   - 配置动态导入策略
   - 建立游戏生命周期管理

2. **核心管理器**
   - GameManager（游戏总控）
   - SceneManager（场景切换）
   - EventBus（事件通信）

3. **配置系统**
   - 游戏全局配置
   - 关卡配置结构
   - 常量定义

### 第二阶段：场景系统
**目标**：实现基础场景流程，建立游戏主循环

1. **场景基类**
   - 统一的生命周期
   - 资源管理接口
   - 转场动画系统

2. **核心场景**
   - PreloadScene（资源预加载）
   - MainMenuScene（主菜单）
   - GameplayScene（游戏主场景骨架）

### 第三阶段：地图与环境
**目标**：构建游戏世界的静态元素

1. **地图系统**
   - 办公室布局生成
   - 工位配置系统
   - 可视化地图编辑器（JSON配置）

2. **环境元素**
   - 办公桌、墙壁等静态物体
   - 装饰性元素
   - 碰撞边界设置

### 第四阶段：玩家系统
**目标**：实现玩家的基础交互

1. **玩家实体**
   - 玩家精灵与动画
   - 位置管理（固定工位）
   - 基础状态（工作/摸鱼）

2. **控制系统**
   - 鼠标点击响应
   - 状态切换逻辑
   - 动画反馈

3. **状态机**
   - 工作状态
   - 摸鱼状态
   - 被抓状态
   - 状态转换规则

### 第五阶段：时间与进度系统
**目标**：实现游戏的核心计时和进度机制

1. **时间系统**
   - 5分钟倒计时
   - 游戏时间映射（9:00-19:00）
   - 时间暂停/恢复

2. **进度条系统**
   - 工作进度条（30秒累计）
   - 摸鱼进度条（点击累积）
   - 视觉反馈（颜色渐变）

### 第六阶段：摸鱼小游戏
**目标**：实现摸鱼状态下的互动玩法

1. **点击系统**
   - 快速点击机制
   - 随机点数生成
   - 连击系统

2. **金币系统**
   - 100点兑换机制
   - 金币动画效果
   - 累计统计

### 第七阶段：AI巡查员系统
**目标**：实现游戏的主要挑战元素

1. **巡查员实体**
   - 基类设计（组长/主管/总监/Boss）
   - 属性配置（速度、视野、频率）
   - 动画系统

2. **巡逻系统**
   - 路径点设置
   - 路径跟随算法
   - 随机巡逻模式

3. **视野锥系统**
   - 扇形视野渲染
   - 旋转机制
   - 碰撞检测算法
   - 遮挡物判定

### 第八阶段：检测与判定系统
**目标**：实现游戏的核心判定逻辑

1. **检测系统**
   - 玩家状态检测
   - 视野内判定
   - 被发现逻辑

2. **游戏结束判定**
   - 过劳判定（工作>30秒）
   - 被抓判定
   - 金币不足判定
   - 通关判定

### 第九阶段：UI界面系统
**目标**：完善游戏的用户界面

1. **HUD界面**
   - 顶部信息栏（时间、金币、关卡）
   - 底部控制区（按钮、进度条）
   - 实时数据更新

2. **菜单系统**
   - 主菜单
   - 暂停菜单
   - 设置界面

3. **弹窗系统**
   - 游戏结束弹窗
   - 成就提示
   - 教程引导

### 第十阶段：音效与反馈
**目标**：增强游戏体验

1. **音效系统**
   - 背景音乐
   - 按钮音效
   - 警报音效
   - 成就音效

2. **视觉反馈**
   - 粒子效果
   - 屏幕震动
   - 过渡动画

### 第十一阶段：优化与适配
**目标**：提升游戏性能和兼容性

1. **性能优化**
   - 对象池
   - 渲染优化
   - 资源懒加载

2. **移动端适配**
   - 响应式布局
   - 触摸控制
   - 屏幕适配

3. **浏览器兼容**
   - WebGL降级
   - 音频兼容
   - 性能检测

## 技术难点与解决方案

### 1. Phaser与Next.js集成
**问题**：SSR环境下Phaser无法初始化
**方案**：
- 使用dynamic import with { ssr: false }
- 创建客户端专用组件
- 条件渲染策略

### 2. 视野锥检测性能
**问题**：多个巡查员同时检测造成性能问题
**方案**：
- 空间哈希优化
- 帧间隔检测
- 只检测屏幕内的巡查员

### 3. 状态同步
**问题**：游戏状态与UI状态同步
**方案**：
- 使用Zustand统一状态管理
- 事件驱动更新
- 单向数据流

### 4. 移动端性能
**问题**：移动设备性能限制
**方案**：
- 降低渲染分辨率
- 简化粒子效果
- 触摸优化

## 测试计划

### 功能测试检查点
- [ ] 场景切换流畅性
- [ ] 状态机正确性
- [ ] 计时系统准确性
- [ ] 碰撞检测准确性
- [ ] UI响应及时性
- [ ] 音效播放正常
- [ ] 移动端操作流畅

### 性能基准
- FPS稳定在60
- 内存占用<200MB
- 加载时间<3秒
- 响应延迟<16ms

## 里程碑

| 阶段 | 完成标准 | 预计时间 |
|------|---------|---------|
| MVP | 核心玩法可玩 | 2周 |
| Alpha | 所有系统集成 | 3周 |
| Beta | 功能完整+优化 | 4周 |
| Release | 全平台测试通过 | 5周 |